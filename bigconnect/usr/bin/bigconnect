#!/bin/bash

#Manage Connection
#
#Authors:
#  Bruno Goncalves Araujo <www.biglinux.com.br>
#
#License: GPLv2 or later
#################################################


#Check permission
if test $(id -u) != 0
then
    echo "Need root permission"
    exit 0
fi

mkdir /etc/bigconnect 2> /dev/null
#Options
case "$1" in
########################
    --scan-wireless)
########################

  a=0
  c=0
  d=0
  x=0
  while read line
  do
   case $line in
    *ESSID* )
        line=${line#*ESSID:}
        essid[$a]=${line//\"/}
        a=$((a + 1))
        ;;
    *key:*)
        line=${line#*Encryption key:}
        key[$d]=$line
        d=$((d + 1))
        ;;
    *Quality*)
        line=${line#*Quality=}
        quality[$c]=$line
        c=$((c + 1))
        ;;

   esac
	done < <(iwlist $2 scan 2>/dev/null) #the redirect gets rid of "lo        Interface doesn't support scanning."

	while [ $x -lt ${#essid[@]} ];do
	  echo "name:${essid[$x]}   quality:$(echo "${quality[$x]}"|sed 's/Signal.*//g')   password:${key[$x]}"
	  (( x++ ))
	done

	exit 0
    ;;

########################
    --list-interfaces)
########################


ifconfig -a | cut -f1 -d " " | sed 's/^lo$//g;s/^sit0$//g;/^$/d;'
;;


########################
    --wpa-password)
########################

	
	wpa_passphrase "$3" "$4" | sed 's/#psk=.*//g' > /etc/bigconnect/wpa_supplicant_big.conf

	echo "cd /etc/bigconnect/
killall wpa_supplicant 2> /dev/null
ifconfig $1 up 2> /dev/null
nohup wpa_supplicant -i \"$2\" -c /etc/bigconnect/wpa_supplicant_big.conf -D wext > /dev/null 2> /dev/null &" > /etc/bigconnect/password

	chmod 700 /etc/bigconnect/password
	chmod +x /etc/bigconnect/password
	/etc/bigconnect/password
	sleep 3

	if [ "$(ifconfig wlan0 | grep "UP BROADCAST RUNNING")" != "" ]; then
	  echo "ok"
	else
	  echo "fail"
	fi

	exit 0
    ;;
    

########################
    --wep-password)
########################

	echo "killall wpa_supplicant 2> /dev/null
ifconfig $2 down 2> /dev/null
iwconfig $2 essid $3 2> /dev/null
iwconfig $2 key restricted $4" > /etc/bigconnect/password

	chmod 700 /etc/bigconnect/password
	chmod +x /etc/bigconnect/password
	/etc/bigconnect/password

	exit 0
    ;;


########################
    --ip-add)
########################

	echo "if [ ! -e \"/etc/bigconnect/password\" ]; then
ifconfig $2 down
ifconfig $2 up
fi

ifconfig $2 $3 netmask $4 up
sleep 1
ifconfig $2 $3 netmask $4 up
route del default
route add default gw $5 dev $2
" > /etc/bigconnect/connect

      echo "$2" > /etc/bigconnect/interface


      if [ "$7" != "" ]; then
            chattr -i /etc/resolv.conf
      echo '# Generated by BigConnect' > /etc/resolv.conf
      for i in $(echo "$*" |cut -d" " -f6,7,8,9)
      do
      echo "nameserver $i" >> /etc/resolv.conf
      done
      chattr +i /etc/resolv.conf
      fi


	chmod +x /etc/bigconnect/connect
	/etc/bigconnect/connect


	exit 0
    ;;


########################
    --ip-dhcp)
########################

	echo "#!/bin/bash

if [ ! -e \"/etc/bigconnect/password\" ]; then
ifconfig $2 down
ifconfig $2 up
fi

dhclient $2
" > /etc/bigconnect/connect


	echo "$2" > /etc/bigconnect/interface

	chmod +x /etc/bigconnect/connect
	/etc/bigconnect/connect


	exit 0

    ;;


########################
    --no-password)
########################
	echo "killall wpa_supplicant 2> /dev/null
ifconfig $2 down 2> /dev/null
iwconfig $2 essid $3 2> /dev/null" > /etc/bigconnect/password

	chmod +x /etc/bigconnect/password
	/etc/bigconnect/password
	exit 0

    ;;

########################
    --clear-interface)
########################
	ifconfig "$2" down
	ifconfig "$2" up

	exit 0
    
    ;;

########################
    --enable-autostart)
########################


echo '# BigConnect

description	"Connect to internet"
author		"Bruno Goncalves Araujo"

start on (starting networking)
script
	/etc/bigconnect/password
	/etc/bigconnect/connect

	sleep 5
	if [ "$(bigconnect --check-ip $(cat /etc/bigconnect/interface))" = "" ]; then
		/etc/bigconnect/password
		/etc/bigconnect/connect
	else
		exit 0
	fi

	sleep 5
	if [ "$(bigconnect --check-ip $(cat /etc/bigconnect/interface))" = "" ]; then
		/etc/bigconnect/password
		/etc/bigconnect/connect
	else
		exit 0
	fi

	sleep 5
	if [ "$(bigconnect --check-ip $(cat /etc/bigconnect/interface))" = "" ]; then
		/etc/bigconnect/password
		/etc/bigconnect/connect
	else
		exit 0
	fi

	sleep 5
	if [ "$(bigconnect --check-ip $(cat /etc/bigconnect/interface))" = "" ]; then
		/etc/bigconnect/password
		/etc/bigconnect/connect
	else
		exit 0
	fi

	sleep 5
	if [ "$(bigconnect --check-ip $(cat /etc/bigconnect/interface))" = "" ]; then
		/etc/bigconnect/password
		/etc/bigconnect/connect
	else
		exit 0
	fi
end script
' > /etc/init/bigconnect.conf


    ;;
    
    
########################
    --disable-autostart)
########################

	rm -f /etc/init/bigconnect.conf

    ;;    


########################
    --check-ip)
########################

	LC_ALL_BACKUP=$LC_ALL
	export LC_ALL=C
	ifconfig $2 | grep "inet" | awk '{print $2}' | sed 's/addr://g;/^$/d'    
	export LC_ALL=$LC_ALL_BACKUP
    ;;    


    
########################
    *)
########################
        echo "Manage Connection

--list-interfaces List all net devices
--scan-wireless   INTERFACE
--no-password	  INTERFACE ESSID 	   ( Example: --no-password wlan0 My_Network )
--wpa-password    INTERFACE ESSID PASSWORD ( Example: --wpa-connect wlan0 My_Network mypass )
--wep-password    INTERFACE ESSID PASSWORD ( Example: --wep-connect wlan0 My_Network 123456789 )
--ip-add          INTERFACE IP NETMASK GATEWAY DNS1 DNS2 ( Example: 192.168.1.10 255.255.255.0 192.168.1.254 8.8.8.8 8.8.4.4 )
--ip-dhcp         INTERFACE ( Example: --ip-dhcp eth0 )
--clear-interface INTERFACE ( Example: --clear-interface eth0 )
--enable-autostart
--disable-autostart
--check-ip	  INTERFACE
"

    ;;

esac

